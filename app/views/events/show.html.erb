<div class="page-header">
	<h1><%= @event.name %></h1>
  <h3><%= show_date(@event) %> <%= show_level(@event) %></h3>
</div>


<div class="row text-right">
  <form class="navbar-form" role="search">
    <div class="form-group">
      <input type="text" class="form-control" placeholder="Team Number or Name" name="search">
    </div>
    <button type="submit" class="btn btn-info">Search Matches</button>
  </form>
</div>

<% matches = [] %>
  <% if params[:search] %>
    <% teams = Team.all.where('lower(name) LIKE ? OR number = ?', "%#{params[:search]}%".downcase, "#{params[:search]}".to_i) %>

    <% teams.each do |t| %>
      <% tmatches = getEventMatches(t, @event) %>
      <% tmatches.each {|m| matches << m if !matches.include?(m)} %>
    <% end %>
  <% else %>
    <% matches = @event.matches %>
  <% end %>


<h2>Matches</h2>
<table class='table table-striped table-hover'>
  <thead>
  <tr>
    <th>Match #</th>
    <th><%= red("Red 1") %></th>
    <th><%= red("Red 2") %></th>
    <th><%= blue("Blue 1") %></th>
    <th><%= blue("Blue 2") %></th>
    <th><%= red("Red") %></th>
    <th><%= blue("Blue") %></th>
  </tr>
  </thead>
  <tbody>
    <%= render matches.sort_by {|m| m.number[0]=~ /\A\d+\z/ ? ['A', Integer(m.number)] : [m.number[0], Integer(m.number[1..-1])] } %>
  </tbody>
</table>
<div class="text-right">
    <%= link_to 'New Match', new_event_match_path(@event), class:'btn btn-primary' if can? :modify, Match%> <br><br>
</div>


<h2>Competing Teams</h2>
<table class='table table-striped table-hover'>
  <thead>
  <tr>
    <th><%= link_to "Team #", @event %></th>
    <th><%= link_to "Team Name", event_path(@event,filter:"name") %></th>
    <th><%= link_to "Event High Score", event_path(@event,filter:"ehigh") %></th>
    <th><%= link_to "Event Avg Score", event_path(@event,filter:"eavg") %></th>
    <th><%= link_to "Event Win %", event_path(@event,filter:"eperc") %></th>
    <th><%= link_to "Event Avg Contribution", event_path(@event,filter:"econt") %></th> 
  </tr>   
  </thead>

  <% if params[:filter] == "name" %>
    <% teams = @event.teams.order(:name) %>
  <% elsif params[:filter] == "ehigh" %>
    <% teams = @event.teams.sort_by {|t| [-eventHighScore(t, @event), t.name]} %>
  <% elsif params[:filter] == "eavg" %>
    <% teams = @event.teams.sort_by {|t| [-eventAvgScore(t, @event), t.name]} %>
  <% elsif params[:filter] == "eperc" %>
    <% teams = @event.teams.sort_by {|t| [-eventWinPerc(t, @event), t.name]} %>
  <% elsif params[:filter] == "econt" %>
    <% teams = @event.teams.sort_by {|t| [-eventAvgCont(t, @event), t.name]} %>
  <% else %>
    <% teams = @event.teams.order(:number) %>
  <% end %>

  <tbody>
    <% teams.each do |t| %>
    <tr>
      <td><%= t.number %></td>
      <td> <a href="<%= team_path(t) %>" style=" text-decoration: none;"> <%= t.name %></a></td>
      <td><%= eventHighScore(t, @event) %></td>
      <td><%= eventAvgScore(t, @event) %></td>
      <td><%= eventWinPerc(t, @event) %></td>
      <td><%= eventAvgCont(t, @event) %></td>
    </tr>
    <% end %>
  </tbody>
</table>

<br>
<br>
<div class="row text-right">
	<%= link_to fa_icon('pencil', text:'Edit Event'), edit_event_path(@event), class:'btn btn-default' if can? :modify, Event%> 
	<%= link_to fa_icon('trash-o', text:'Destroy Event'), @event, method: :delete, data: { confirm: 'Are you sure?' }, class:'btn btn-danger' if can? :destroy, Event%>
</div>